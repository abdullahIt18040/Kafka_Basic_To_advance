## Consumer Offset ржХрзА?

Kafka-рждрзЗ ржпржЦржи ржХрзЛржирзЛ consumer (ржЧрзНрж░рж╛рж╣ржХ) ржХрзЛржирзЛ topic ржерзЗржХрзЗ data ржкрзЬрзЗ, рждржЦржи Kafka рж╕рзЗржЗ consumer ржХрзЛржерж╛рзЯ ржкрж░рзНржпржирзНржд ржкрзЬрзЗржЫрзЗ рждрж╛ offset ржжрж┐рзЯрзЗ ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рзЗ рж░рж╛ржЦрзЗред

 Offset рж╣рж▓рзЛ ржкрзНрж░рждрж┐ржЯрж┐ message-ржПрж░ ржЬржирзНржп ржПржХржЯрж┐ unique number (0, 1, 2, 3, ... ржЗрждрзНржпрж╛ржжрж┐)ред
ржПржЯрж╛ message-ржПрж░ position ржмрж╛ index ржПрж░ ржорждрзЛ ржХрж╛ржЬ ржХрж░рзЗред
```
 ржЙржжрж╛рж╣рж░ржг:

ржзрж░рзБржи ржЖржкржирж╛рж░ ржПржХржЯрж╛ topic ржЖржЫрзЗ тАФ orders
ржПрждрзЗ рзлржЯрж┐ message ржЖржЫрзЗ:

Offset	Message
0	Order #1
1	Order #2
2	Order #3
3	Order #4
4	Order #5

ржПржЦржи ржЖржкржирж╛рж░ consumer ржпржжрж┐ ржкрзНрж░ржержо рзйржЯрж╛ message ржкрзЬрзЗ,
рждрж╛рж╣рж▓рзЗ Kafka ржоржирзЗ рж░рж╛ржЦржмрзЗ ржпрзЗ consumer-ржПрж░ offset ржПржЦржи 2 ржкрж░рзНржпржирзНржд ржкрзМржБржЫрзЗржЫрзЗред

 ржорж╛ржирзЗ consumer 0, 1, 2 offset ржкрж░рзНржпржирзНржд message consume ржХрж░рзЗржЫрзЗред

 Consumer Offset ржХрзЗржи ржжрж░ржХрж╛рж░:
ржХрж╛рж░ржг	ржмрзНржпрж╛ржЦрзНржпрж╛
ЁЯФБ Restart ржПрж░ ржкрж░ ржерзЗржХрзЗ ржЖржмрж╛рж░ рж╢рзБрж░рзБ ржХрж░рж╛рж░ ржЬржирзНржп	ржпржжрж┐ consumer ржмржирзНржз рж╣рзЯрзЗ ржпрж╛рзЯ ржмрж╛ restart рж╣рзЯ, Kafka ржЬрж╛ржирзЗ рж╢рзЗрж╖ ржХрзЛржи offset ржкрж░рзНржпржирзНржд message ржкрзЬрж╛ рж╣рзЯрзЗржЫрж┐рж▓ред ржлрж▓рзЗ consumer рж╕рзЗржЦрж╛ржи ржерзЗржХрзЗржЗ ржЖржмрж╛рж░ рж╢рзБрж░рзБ ржХрж░рждрзЗ ржкрж╛рж░рзЗред
тЬЕ Duplicate ржПрзЬрж╛ржирзЛрж░ ржЬржирзНржп	Offset ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рзЗ рж░рж╛ржЦрж▓рзЗ ржПржХржЗ message ржмрж╛рж░ржмрж╛рж░ ржкрзЬрж╛ рж╣рзЯ ржирж╛ред
ЁЯУК Monitoring ржУ Lag Check ржХрж░рж╛рж░ ржЬржирзНржп	Offset ржерзЗржХрзЗ ржмрзЛржЭрж╛ ржпрж╛рзЯ consumer ржХржд ржкрж┐ржЫрж┐рзЯрзЗ ржЖржЫрзЗ (lag) ржмрж╛ ржХржд message ржПржЦржирзЛ consume рж╣рзЯржирж┐ред
ЁЯзй Offset ржХрзЛржерж╛рзЯ рж╕ржВрж░ржХрзНрж╖ржг рж╣рзЯ?

Kafka offset рж╕рж╛ржзрж╛рж░ржгржд __consumer_offsets ржирж╛ржорзЗрж░ ржПржХржЯрж┐ internal topic-ржП рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзЗред
ржПржЗ ржЯржкрж┐ржХ Kafka ржирж┐ржЬрзЗржЗ manage ржХрж░рзЗред

ржЙржжрж╛рж╣рж░ржг:

ржзрж░рзБржи consumer group-ржПрж░ ржирж╛ржо group1
topic orders
partition 0 ржПрж░ рж╕рж░рзНржмрж╢рзЗрж╖ offset рж╣рж▓рзЛ 100

consumer ржпржжрж┐ offset 95 ржкрж░рзНржпржирзНржд ржкрзЬрзЗ ржерж╛ржХрзЗ,
рждрж╛рж╣рж▓рзЗ consumer lag = 100 - 95 = 5 message ржкрж┐ржЫрж┐рзЯрзЗ ржЖржЫрзЗред
```
 рж╕ржВржХрзНрж╖рзЗржкрзЗ ржмрж╛ржВрж▓рж╛ рж╕ржВржЬрзНржЮрж╛:

Consumer Offset рж╣рж▓рзЛ Kafka-рж░ ржПржХржЯрж┐ рж╕ржВржЦрзНржпрж╛, ржпрж╛ ржмрж▓рзЗ ржжрзЗрзЯ ржХрзЛржирзЛ consumer ржХрзЛржи message ржкрж░рзНржпржирзНржд ржкрзЬрзЗржЫрзЗред
ржПрж░ ржорж╛ржзрзНржпржорзЗ Kafka consumer-ржПрж░ ржЕржмрж╕рзНржерж╛ржи ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рзЗ, ржпрж╛рждрзЗ ржкрзБржирж░рж╛рзЯ рж╢рзБрж░рзБ рж╣рж▓рзЗ ржмрж╛ рждрзНрж░рзБржЯрж┐ ржШржЯрж▓рзЗ ржбрзЗржЯрж╛ рж╣рж╛рж░рж╛рзЯ ржирж╛ ржПржмржВ ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ ржирж╛ рж╣рзЯред


```
ржзрж╛ржк рзз: ржлрж╛ржЗрж▓ ржЖржкрж▓рзЛржб

ржЗржЙржЬрж╛рж░ .xlsx ржлрж╛ржЗрж▓ ржЖржкрж▓рзЛржб ржХрж░рзЗред
ржЖржкржирж╛рж░ API / Frontend ржлрж╛ржЗрж▓ржЯрж╛ ржирж┐ржпрж╝рзЗ Kafka-ржП ржкрж╛ржарж╛ржпрж╝ред

textFrontend тЖТ [POST /upload] тЖТ Kafka Topic: xlsx.incoming

Kafka-ржП ржлрж╛ржЗрж▓ржЯрж╛ ржмрж╛ржЗржЯ (byte[]) рж╣рж┐рж╕рзЗржмрзЗ ржпрж╛ржпрж╝ред


ржзрж╛ржк рзи: File-Converter рж╕рж╛рж░рзНржнрж┐рж╕

рззрзиржЯрж╛ ржерзНрж░рзЗржб ржЪрж▓ржЫрзЗред
ржкрзНрж░рждрж┐ржЯрж┐ ржерзНрж░рзЗржб Kafka ржерзЗржХрзЗ ржПржХржЯрж╛ ржлрж╛ржЗрж▓ ржирзЗржпрж╝ред
Apache POI ржжрж┐ржпрж╝рзЗ .xlsx тЖТ .csv ржХрж░рзЗред
ржХржиржнрж╛рж░рзНржЯ рж╣ржУржпрж╝рж╛ .csv тЖТ Kafka-ржП ржкрж╛ржарж╛ржпрж╝ред

textKafka (xlsx.incoming) тЖТ [Converter 1] тЖТ Kafka (csv.validated)
Kafka (xlsx.incoming) тЖТ [Converter 2] тЖТ Kafka (csv.validated)
...
Kafka (xlsx.incoming) тЖТ [Converter 12] тЖТ Kafka (csv.validated)

рззрзиржЯрж╛ ржлрж╛ржЗрж▓ ржПржХрж╕рж╛ржерзЗ ржХржиржнрж╛рж░рзНржЯ рж╣ржЪрзНржЫрзЗ!


ржзрж╛ржк рзй: Validator рж╕рж╛рж░рзНржнрж┐рж╕

рзирзкржЯрж╛ ржерзНрж░рзЗржб ржЪрж▓ржЫрзЗ (ржХрж╛рж░ржг ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи ржмрзЗрж╢рж┐ CPU рж▓рж╛ржЧрзЗ)ред
Kafka ржерзЗржХрзЗ .csv ржирзЗржпрж╝ред
ржкрзНрж░рждрж┐ рж░рзЛ ржЪрзЗржХ ржХрж░рзЗ:

ржирж╛ржо ржЖржЫрзЗ?
ржЗржорзЗржЗрж▓ @ ржЖржЫрзЗ?
рждрж╛рж░рж┐ржЦ DD-MM-YYYY?



javaif (email.contains("@") && date.matches("\\d{2}-\\d{2}-\\d{4}")) {
    тЖТ рж╕ржарж┐ржХ тЖТ Kafka: csv.load-ready
} else {
    тЖТ ржнрзБрж▓ тЖТ Kafka: csv.rejected
}

рзирзкржЯрж╛ CSV ржлрж╛ржЗрж▓ ржПржХрж╕рж╛ржерзЗ ржЪрзЗржХ рж╣ржЪрзНржЫрзЗ!


ржзрж╛ржк рзк: Loader рж╕рж╛рж░рзНржнрж┐рж╕

рззрзиржЯрж╛ ржерзНрж░рзЗржбред
Kafka ржерзЗржХрзЗ csv.load-ready ржирзЗржпрж╝ред
ржЯрзЗржорзНржк ржлрзЛрж▓рзНржбрж╛рж░рзЗ .csv рж╕рзЗржн ржХрж░рзЗред
.ctl ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзЗред
sqlldr ржЪрж╛рж▓рж╛ржпрж╝:

bashsqlldr user/pwd@db control=load.ctl direct=true parallel=true

рззрзиржЯрж╛ ржлрж╛ржЗрж▓ ржПржХрж╕рж╛ржерзЗ Oracle-ржП рж▓рзЛржб рж╣ржЪрзНржЫрзЗ!


ржзрж╛ржк рзл: ржнрзБрж▓ ржбрзЗржЯрж╛ ржХрзА рж╣ржмрзЗ?

csv.rejected ржЯржкрж┐ржХрзЗ ржпрж╛ржпрж╝ред
ржЖржкржирж┐ ржкрж░рзЗ ржжрзЗржЦрждрзЗ ржкрж╛рж░рзЗржиред
ржЕржержмрж╛ Alert ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░рзЗржиред
ржкрж░рзЗ Reprocess ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред


Kafka ржХрзАржнрж╛ржмрзЗ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржмрж╛ржбрж╝рж╛ржпрж╝? (ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд)



































ржлрж┐ржЪрж╛рж░ржХрзА ржХрж░рзЗржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржЧрзЗржЗржиржкрж╛рж░рзНржЯрж┐рж╢ржирззрзиржЯрж╛ тЖТ рззрзиржЯрж╛ ржерзНрж░рзЗржб ржПржХрж╕рж╛ржерзЗрззрзи├Ч ржжрзНрж░рзБрждржЕрзНржпрж╛рж╕рж┐ржЩрзНржХржХрзЗржЙ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзЗ ржирж╛ржХрзЛржирзЛ ржмрзНрж▓ржХ ржирзЗржЗржмрзНржпрж╛ржЪрж┐ржВрзлрзжрзж рж░рзЗржХрж░рзНржб ржПржХрж╕рж╛ржерзЗ ржкрж╛ржарж╛ржпрж╝ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХржо рж▓рж╛ржЧрзЗржХржорзНржкрзНрж░рзЗрж╢ржиsnappy тЖТ рззрзжрзжMB тЖТ рзирзжMBрзл├Ч ржХржо ржбрзЗржЯрж╛KRaftZooKeeper ржирзЗржЗ тЖТ ржжрзНрж░рзБрждрзйрзж% ржХржо рж▓рзЗржЯрзЗржирзНрж╕рж┐

ржЙржжрж╛рж╣рж░ржг: рззрзжрзж ржлрж╛ржЗрж▓ (ржкрзНрж░рждрж┐ржЯрж┐ рззрзжMB)






























ржзрж╛ржкKafka ржЫрж╛ржбрж╝рж╛Kafka ржжрж┐ржпрж╝рзЗржХржиржнрж╛рж░рзНржЯрззрзжрзж ├Ч рзкрзл рж╕рзЗржХрзЗржирзНржб = рзнрзл ржорж┐ржирж┐ржЯрззрзжрзж / рззрзи = рзп ржмрзНржпрж╛ржЪ ├Ч рзо рж╕рзЗржХрзЗржирзНржб = рзнрзи рж╕рзЗржХрзЗржирзНржбржнрзНржпрж╛рж▓рж┐ржбрзЗржЯрззрзжрзж ├Ч рзи ржорж┐ржирж┐ржЯ = рзирзжрзж ржорж┐ржирж┐ржЯрззрзжрзж / рзирзк = рзл ржмрзНржпрж╛ржЪ ├Ч рзирзи рж╕рзЗржХрзЗржирзНржб = рзз.рзо ржорж┐ржирж┐ржЯрж▓рзЛржбрззрзжрзж ├Ч рзпрзж рж╕рзЗржХрзЗржирзНржб = рззрзлрзж ржорж┐ржирж┐ржЯрззрзжрзж / рззрзи = рзп ржмрзНржпрж╛ржЪ ├Ч рззрзл рж╕рзЗржХрзЗржирзНржб = рзи.рзи ржорж┐ржирж┐ржЯржорзЛржЯрзн+ ржШржгрзНржЯрж╛~рзм ржорж┐ржирж┐ржЯ

рзнрзж├Ч ржжрзНрж░рзБржд!
```
