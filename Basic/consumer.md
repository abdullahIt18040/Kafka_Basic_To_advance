
## number of consumers in a group should be  equal noumber of  pationtion
## Consumer Offset ржХрзА?

## Consumer Group ржХрзА?
Kafka-рждрзЗ Consumer Group рж╣рж▓рзЛ ржПржоржи ржПржХржЯрж┐ ржмрзНржпржмрж╕рзНржерж╛ ржпрзЗржЦрж╛ржирзЗ ржПржХрж╛ржзрж┐ржХ consumer ржорж┐рж▓рзЗржЗ ржПржХржЯрж┐ group рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░рзЗред
ржПржХржЯрж┐ topic-ржПрж░ ржорзЗрж╕рзЗржЬржЧрзБрж▓рзЛ Kafka рж╕рзЗржЗ ржЧрзНрж░рзБржкрзЗрж░ consumer ржЧрзБрж▓рзЛрж░ ржоржзрзНржпрзЗ ржнрж╛ржЧ ржХрж░рзЗ ржжрзЗрзЯред

ЁЯУНржПрж░ ржорж╛ржирзЗ:

ржПржХржЯрж╛ consumer group тЖТ ржмрж╣рзБ consumer ржХрж╛ржЬ ржнрж╛ржЧрж╛ржнрж╛ржЧрж┐ ржХрж░рзЗ ржирзЗржмрзЗ

ржорзЗрж╕рзЗржЬ ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ рж╣ржмрзЗ ржирж╛ (ржПржХ consumer ржПржХржмрж╛рж░ ржорзЗрж╕рзЗржЬ ржирзЗржмрзЗ)

тЬЕ ржзрж╛ржк рзз: ржХрж┐ржЫрзБ ржорзЗрж╕рзЗржЬ ржкрзНрж░ржбрж┐ржЙрж╕ ржХрж░рзБржи (ржЖржЧрзЗ ржирж╛ ржХрж░рж▓рзЗ)

ржЯрж╛рж░рзНржорж┐ржирж╛рж▓рзЗ рж▓рж┐ржЦрзБржи:

C:\kafka> .\bin\windows\kafka-console-producer.bat --topic my-first-topicone --bootstrap-server localhost:9092


ржПржЦржи ржХрж┐ржЫрзБ ржорзЗрж╕рзЗржЬ рж▓рж┐ржЦрзЗ Enter ржЪрж╛ржкрзБржиред

тЬЕ ржзрж╛ржк рзи: ржПржХржЯрж┐ consumer group ржжрж┐рзЯрзЗ consumer ржЪрж╛рж▓рж╛ржи

ржзрж░рзБржи ржЖржкржирж╛рж░ ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо my-group, рждржЦржи рж▓рж┐ржЦрзБржи:

C:\kafka> .\bin\windows\kafka-console-consumer.bat --topic my-first-topicone --group my-group --bootstrap-server localhost:9092


ЁЯСЙ ржПржЯрж╛ my-group ржирж╛ржорзЗ ржПржХржЯрж┐ ржирждрзБржи group рждрзИрж░рж┐ ржХрж░ржмрзЗ (ржпржжрж┐ ржЖржЧрзЗ ржирж╛ ржерж╛ржХрзЗ)ред

тЬЕ ржзрж╛ржк рзй: ржжрзНржмрж┐рждрзАрзЯ consumer ржЪрж╛рж▓рж╛ржи ржПржХржЗ ржЧрзНрж░рзБржкрзЗ

ржЖрж░рзЗржХржЯрж┐ ржирждрзБржи ржЯрж╛рж░рзНржорж┐ржирж╛рж▓ ржЦрзБрж▓рзЗ ржЖржмрж╛рж░ рж▓рж┐ржЦрзБржи:

C:\kafka> .\bin\windows\kafka-console-consumer.bat --topic my-first-topicone --group my-group --bootstrap-server localhost:9092


ЁЯУНржПржЦржи ржЖржкржирж╛рж░ ржжрзБржЗржЯрж┐ consumer ржПржХржЗ ржЧрзНрж░рзБржкрзЗ ржЖржЫрзЗред
Kafka ржкрзНрж░рждрж┐ржЯрж┐ ржорзЗрж╕рзЗржЬ ржПржХржЯрж┐ consumer-ржП ржкрж╛ржарж╛ржмрзЗред (рж▓рзЛржб ржмрзНржпрж╛рж▓рзЗржирзНрж╕рж┐ржВ рж╣ржмрзЗ)

ржзрж╛ржк рзк: ржЧрзНрж░рзБржкрзЗрж░ ржЕржмрж╕рзНржерж╛ ржжрзЗржЦрждрзЗ ржЪрж╛ржЗрж▓рзЗ
C:\kafka> .\bin\windows\kafka-consumer-groups.bat --describe --group my-group --bootstrap-server localhost:9092


ржПржЯрж┐ ржжрзЗржЦрж╛ржмрзЗ:

рждржерзНржп	ржЕрж░рзНрже
Topic	ржХрзЛржи topic ржерзЗржХрзЗ ржорзЗрж╕рзЗржЬ ржпрж╛ржЪрзНржЫрзЗ
Partition	ржХрзЛржи ржкрж╛рж░рзНржЯрж┐рж╢ржи
Current Offset	ржХржд ржкрж░рзНржпржирзНржд ржкрзЬрж╛ рж╣рзЯрзЗржЫрзЗ
Lag	ржПржЦржиржУ ржХржд ржорзЗрж╕рзЗржЬ ржмрж╛ржХрж┐
ЁЯУМ ржХрзЗржи Consumer Group ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯ?
ржЙржжрзНржжрзЗрж╢рзНржп	ржмрзНржпрж╛ржЦрзНржпрж╛
Load balancing	ржПржХрж╛ржзрж┐ржХ consumer ржПржХрж╕рж╛ржерзЗ ржХрж╛ржЬ ржнрж╛ржЧ ржХрж░рзЗ ржирзЗрзЯ
Scalability	ржЧрзНрж░рзБржкрзЗ ржЖрж░ржУ consumer ржпрзЛржЧ ржХрж░рж▓рзЗ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржмрж╛рзЬрзЗ
No duplicate messages	ржПржХржЯрж┐ ржорзЗрж╕рзЗржЬ ржХрзЗржмрж▓ ржПржХржЯрж┐ consumer-ржП ржпрж╛рзЯ (group-ржПрж░ ржоржзрзНржпрзЗ)


Kafka-рждрзЗ ржпржЦржи ржХрзЛржирзЛ consumer (ржЧрзНрж░рж╛рж╣ржХ) ржХрзЛржирзЛ topic ржерзЗржХрзЗ data ржкрзЬрзЗ, рждржЦржи Kafka рж╕рзЗржЗ consumer ржХрзЛржерж╛рзЯ ржкрж░рзНржпржирзНржд ржкрзЬрзЗржЫрзЗ рждрж╛ offset ржжрж┐рзЯрзЗ ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рзЗ рж░рж╛ржЦрзЗред

 Offset рж╣рж▓рзЛ ржкрзНрж░рждрж┐ржЯрж┐ message-ржПрж░ ржЬржирзНржп ржПржХржЯрж┐ unique number (0, 1, 2, 3, ... ржЗрждрзНржпрж╛ржжрж┐)ред
ржПржЯрж╛ message-ржПрж░ position ржмрж╛ index ржПрж░ ржорждрзЛ ржХрж╛ржЬ ржХрж░рзЗред
```
 ржЙржжрж╛рж╣рж░ржг:

ржзрж░рзБржи ржЖржкржирж╛рж░ ржПржХржЯрж╛ topic ржЖржЫрзЗ тАФ orders
ржПрждрзЗ рзлржЯрж┐ message ржЖржЫрзЗ:

Offset	Message
0	Order #1
1	Order #2
2	Order #3
3	Order #4
4	Order #5

ржПржЦржи ржЖржкржирж╛рж░ consumer ржпржжрж┐ ржкрзНрж░ржержо рзйржЯрж╛ message ржкрзЬрзЗ,
рждрж╛рж╣рж▓рзЗ Kafka ржоржирзЗ рж░рж╛ржЦржмрзЗ ржпрзЗ consumer-ржПрж░ offset ржПржЦржи 2 ржкрж░рзНржпржирзНржд ржкрзМржБржЫрзЗржЫрзЗред

 ржорж╛ржирзЗ consumer 0, 1, 2 offset ржкрж░рзНржпржирзНржд message consume ржХрж░рзЗржЫрзЗред

 Consumer Offset ржХрзЗржи ржжрж░ржХрж╛рж░:
ржХрж╛рж░ржг	ржмрзНржпрж╛ржЦрзНржпрж╛
ЁЯФБ Restart ржПрж░ ржкрж░ ржерзЗржХрзЗ ржЖржмрж╛рж░ рж╢рзБрж░рзБ ржХрж░рж╛рж░ ржЬржирзНржп	ржпржжрж┐ consumer ржмржирзНржз рж╣рзЯрзЗ ржпрж╛рзЯ ржмрж╛ restart рж╣рзЯ, Kafka ржЬрж╛ржирзЗ рж╢рзЗрж╖ ржХрзЛржи offset ржкрж░рзНржпржирзНржд message ржкрзЬрж╛ рж╣рзЯрзЗржЫрж┐рж▓ред ржлрж▓рзЗ consumer рж╕рзЗржЦрж╛ржи ржерзЗржХрзЗржЗ ржЖржмрж╛рж░ рж╢рзБрж░рзБ ржХрж░рждрзЗ ржкрж╛рж░рзЗред
тЬЕ Duplicate ржПрзЬрж╛ржирзЛрж░ ржЬржирзНржп	Offset ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рзЗ рж░рж╛ржЦрж▓рзЗ ржПржХржЗ message ржмрж╛рж░ржмрж╛рж░ ржкрзЬрж╛ рж╣рзЯ ржирж╛ред
ЁЯУК Monitoring ржУ Lag Check ржХрж░рж╛рж░ ржЬржирзНржп	Offset ржерзЗржХрзЗ ржмрзЛржЭрж╛ ржпрж╛рзЯ consumer ржХржд ржкрж┐ржЫрж┐рзЯрзЗ ржЖржЫрзЗ (lag) ржмрж╛ ржХржд message ржПржЦржирзЛ consume рж╣рзЯржирж┐ред
ЁЯзй Offset ржХрзЛржерж╛рзЯ рж╕ржВрж░ржХрзНрж╖ржг рж╣рзЯ?

Kafka offset рж╕рж╛ржзрж╛рж░ржгржд __consumer_offsets ржирж╛ржорзЗрж░ ржПржХржЯрж┐ internal topic-ржП рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзЗред
ржПржЗ ржЯржкрж┐ржХ Kafka ржирж┐ржЬрзЗржЗ manage ржХрж░рзЗред

ржЙржжрж╛рж╣рж░ржг:

ржзрж░рзБржи consumer group-ржПрж░ ржирж╛ржо group1
topic orders
partition 0 ржПрж░ рж╕рж░рзНржмрж╢рзЗрж╖ offset рж╣рж▓рзЛ 100

consumer ржпржжрж┐ offset 95 ржкрж░рзНржпржирзНржд ржкрзЬрзЗ ржерж╛ржХрзЗ,
рждрж╛рж╣рж▓рзЗ consumer lag = 100 - 95 = 5 message ржкрж┐ржЫрж┐рзЯрзЗ ржЖржЫрзЗред
```
 рж╕ржВржХрзНрж╖рзЗржкрзЗ ржмрж╛ржВрж▓рж╛ рж╕ржВржЬрзНржЮрж╛:

Consumer Offset рж╣рж▓рзЛ Kafka-рж░ ржПржХржЯрж┐ рж╕ржВржЦрзНржпрж╛, ржпрж╛ ржмрж▓рзЗ ржжрзЗрзЯ ржХрзЛржирзЛ consumer ржХрзЛржи message ржкрж░рзНржпржирзНржд ржкрзЬрзЗржЫрзЗред
ржПрж░ ржорж╛ржзрзНржпржорзЗ Kafka consumer-ржПрж░ ржЕржмрж╕рзНржерж╛ржи ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рзЗ, ржпрж╛рждрзЗ ржкрзБржирж░рж╛рзЯ рж╢рзБрж░рзБ рж╣рж▓рзЗ ржмрж╛ рждрзНрж░рзБржЯрж┐ ржШржЯрж▓рзЗ ржбрзЗржЯрж╛ рж╣рж╛рж░рж╛рзЯ ржирж╛ ржПржмржВ ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ ржирж╛ рж╣рзЯред

### ржпржжрж┐ рж╢рзБржзрзБ ржПржХржЯрж╛ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржкрж╛рж░рзНржЯрж┐рж╢ржи (ржпрзЗржоржи ржкрж╛рж░рзНржЯрж┐рж╢ржи рзз) ржерзЗржХрзЗ ржорзЗрж╕рзЗржЬ ржирж┐рждрзЗ ржЪрж╛ржУ,

рждрж╛рж╣рж▓рзЗ --partition ржЕржкрж╢ржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ рж╣ржмрзЗ ржПржмржВ --group ржмрж╛ржж ржжрж┐рждрзЗ рж╣ржмрзЗ, ржХрж╛рж░ржг ржорзНржпрж╛ржирзБрзЯрж╛рж▓рж┐ ржкрж╛рж░рзНржЯрж┐рж╢ржи ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рж▓рзЗ ржЧрзНрж░рзБржкрзЗрж░ ржХржиржЬрж┐ржЙржорж╛рж░ ржЕрзНржпрж╛рж╕рж╛ржЗржиржорзЗржирзНржЯ ржХрж╛ржЬ ржХрж░ржмрзЗ ржирж╛ред
```
тЬЕ рж╕ржарж┐ржХ ржХржорж╛ржирзНржб (рж╢рзБржзрзБ partition 1 ржерзЗржХрзЗ consume ржХрж░рждрзЗ):
.\bin\windows\kafka-console-consumer.bat --topic my-first-topicone --partition 1 --bootstrap-server localhost:9092

ЁЯФБ ржпржжрж┐ рждрзБржорж┐ рж╢рзБрж░рзБ ржерзЗржХрзЗ (ржкрзБрж░рзЛржирзЛ ржорзЗрж╕рзЗржЬрж╕рж╣) рж╕ржм ржжрзЗржЦрждрзЗ ржЪрж╛ржУ:
.\bin\windows\kafka-console-consumer.bat --topic my-first-topicone --partition 1 --bootstrap-server localhost:9092 --from-beginning
```

тД╣я╕П ржоржирзЗ рж░рж╛ржЦржмрзЗ:

--group ржжрж┐рж▓рзЗ Kafka ржирж┐ржЬрзЗ ржкрж╛рж░рзНржЯрж┐рж╢ржи ржЕрзНржпрж╛рж╕рж╛ржЗржи ржХрж░рзЗ (рждрзБржорж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛)ред

--partition ржжрж┐рж▓рзЗ рждрзБржорж┐ ржирж┐ржЬрзЗ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржкрж╛рж░рзНржЯрж┐рж╢ржи ржмрзЗржЫрзЗ ржирж┐рждрзЗ ржкрж╛рж░ржмрзЗ, ржХрж┐ржирзНрждрзБ рждржЦржи ржЧрзНрж░рзБржк ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛ред

ржЪрж╛ржУрж▓рзЗ ржЖржорж┐ ржжрзЗржЦрж╛рждрзЗ ржкрж╛рж░рж┐ ржХрзАржнрж╛ржмрзЗ ржПржХрж╛ржзрж┐ржХ ржХржиржЬрж┐ржЙржорж╛рж░ ржПржХрж╕рж╛ржерзЗ ржЪрж╛рж▓рж┐рзЯрзЗ ржкрзНрж░рждрж┐ржЯрж┐ ржкрж╛рж░рзНржЯрж┐рж╢ржи ржЖрж▓рж╛ржжрж╛ ржХржиржЬрж┐ржЙржорж╛рж░ ржжрж┐рзЯрзЗ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рж╛ ржпрж╛рзЯ тАФ рж╕рзЗржЯрж╛ ржжрзЗржЦрждрзЗ ржЪрж╛ржУ ржХрж┐?

.\bin\windows\kafka-console-consumer.bat --topic siltest --partition 1 --bootstrap-server localhost:9092


```
ржзрж╛ржк рзз: ржлрж╛ржЗрж▓ ржЖржкрж▓рзЛржб

ржЗржЙржЬрж╛рж░ .xlsx ржлрж╛ржЗрж▓ ржЖржкрж▓рзЛржб ржХрж░рзЗред
ржЖржкржирж╛рж░ API / Frontend ржлрж╛ржЗрж▓ржЯрж╛ ржирж┐ржпрж╝рзЗ Kafka-ржП ржкрж╛ржарж╛ржпрж╝ред

textFrontend тЖТ [POST /upload] тЖТ Kafka Topic: xlsx.incoming

Kafka-ржП ржлрж╛ржЗрж▓ржЯрж╛ ржмрж╛ржЗржЯ (byte[]) рж╣рж┐рж╕рзЗржмрзЗ ржпрж╛ржпрж╝ред


ржзрж╛ржк рзи: File-Converter рж╕рж╛рж░рзНржнрж┐рж╕

рззрзиржЯрж╛ ржерзНрж░рзЗржб ржЪрж▓ржЫрзЗред
ржкрзНрж░рждрж┐ржЯрж┐ ржерзНрж░рзЗржб Kafka ржерзЗржХрзЗ ржПржХржЯрж╛ ржлрж╛ржЗрж▓ ржирзЗржпрж╝ред
Apache POI ржжрж┐ржпрж╝рзЗ .xlsx тЖТ .csv ржХрж░рзЗред
ржХржиржнрж╛рж░рзНржЯ рж╣ржУржпрж╝рж╛ .csv тЖТ Kafka-ржП ржкрж╛ржарж╛ржпрж╝ред

textKafka (xlsx.incoming) тЖТ [Converter 1] тЖТ Kafka (csv.validated)
Kafka (xlsx.incoming) тЖТ [Converter 2] тЖТ Kafka (csv.validated)
...
Kafka (xlsx.incoming) тЖТ [Converter 12] тЖТ Kafka (csv.validated)

рззрзиржЯрж╛ ржлрж╛ржЗрж▓ ржПржХрж╕рж╛ржерзЗ ржХржиржнрж╛рж░рзНржЯ рж╣ржЪрзНржЫрзЗ!


ржзрж╛ржк рзй: Validator рж╕рж╛рж░рзНржнрж┐рж╕

рзирзкржЯрж╛ ржерзНрж░рзЗржб ржЪрж▓ржЫрзЗ (ржХрж╛рж░ржг ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи ржмрзЗрж╢рж┐ CPU рж▓рж╛ржЧрзЗ)ред
Kafka ржерзЗржХрзЗ .csv ржирзЗржпрж╝ред
ржкрзНрж░рждрж┐ рж░рзЛ ржЪрзЗржХ ржХрж░рзЗ:

ржирж╛ржо ржЖржЫрзЗ?
ржЗржорзЗржЗрж▓ @ ржЖржЫрзЗ?
рждрж╛рж░рж┐ржЦ DD-MM-YYYY?



javaif (email.contains("@") && date.matches("\\d{2}-\\d{2}-\\d{4}")) {
    тЖТ рж╕ржарж┐ржХ тЖТ Kafka: csv.load-ready
} else {
    тЖТ ржнрзБрж▓ тЖТ Kafka: csv.rejected
}

рзирзкржЯрж╛ CSV ржлрж╛ржЗрж▓ ржПржХрж╕рж╛ржерзЗ ржЪрзЗржХ рж╣ржЪрзНржЫрзЗ!


ржзрж╛ржк рзк: Loader рж╕рж╛рж░рзНржнрж┐рж╕

рззрзиржЯрж╛ ржерзНрж░рзЗржбред
Kafka ржерзЗржХрзЗ csv.load-ready ржирзЗржпрж╝ред
ржЯрзЗржорзНржк ржлрзЛрж▓рзНржбрж╛рж░рзЗ .csv рж╕рзЗржн ржХрж░рзЗред
.ctl ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзЗред
sqlldr ржЪрж╛рж▓рж╛ржпрж╝:

bashsqlldr user/pwd@db control=load.ctl direct=true parallel=true

рззрзиржЯрж╛ ржлрж╛ржЗрж▓ ржПржХрж╕рж╛ржерзЗ Oracle-ржП рж▓рзЛржб рж╣ржЪрзНржЫрзЗ!


ржзрж╛ржк рзл: ржнрзБрж▓ ржбрзЗржЯрж╛ ржХрзА рж╣ржмрзЗ?

csv.rejected ржЯржкрж┐ржХрзЗ ржпрж╛ржпрж╝ред
ржЖржкржирж┐ ржкрж░рзЗ ржжрзЗржЦрждрзЗ ржкрж╛рж░рзЗржиред
ржЕржержмрж╛ Alert ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░рзЗржиред
ржкрж░рзЗ Reprocess ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред


Kafka ржХрзАржнрж╛ржмрзЗ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржмрж╛ржбрж╝рж╛ржпрж╝? (ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд)



































ржлрж┐ржЪрж╛рж░ржХрзА ржХрж░рзЗржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржЧрзЗржЗржиржкрж╛рж░рзНржЯрж┐рж╢ржирззрзиржЯрж╛ тЖТ рззрзиржЯрж╛ ржерзНрж░рзЗржб ржПржХрж╕рж╛ржерзЗрззрзи├Ч ржжрзНрж░рзБрждржЕрзНржпрж╛рж╕рж┐ржЩрзНржХржХрзЗржЙ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзЗ ржирж╛ржХрзЛржирзЛ ржмрзНрж▓ржХ ржирзЗржЗржмрзНржпрж╛ржЪрж┐ржВрзлрзжрзж рж░рзЗржХрж░рзНржб ржПржХрж╕рж╛ржерзЗ ржкрж╛ржарж╛ржпрж╝ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХржо рж▓рж╛ржЧрзЗржХржорзНржкрзНрж░рзЗрж╢ржиsnappy тЖТ рззрзжрзжMB тЖТ рзирзжMBрзл├Ч ржХржо ржбрзЗржЯрж╛KRaftZooKeeper ржирзЗржЗ тЖТ ржжрзНрж░рзБрждрзйрзж% ржХржо рж▓рзЗржЯрзЗржирзНрж╕рж┐

ржЙржжрж╛рж╣рж░ржг: рззрзжрзж ржлрж╛ржЗрж▓ (ржкрзНрж░рждрж┐ржЯрж┐ рззрзжMB)
```

### Kafka KRaft Mode ржП Consumer Rebalancing тАФ ржмрж╛ржВрж▓рж╛ ржмрзНржпрж╛ржЦрзНржпрж╛
```
тЬЕ 1. KRaft Mode ржХрж┐?

ржЖржЧрзЗ Kafka-рж░ metadata (brokers, topics, partitions, consumer groups) ржорзНржпрж╛ржирзЗржЬ ржХрж░рждрзЛ Zookeeperред

KRaft (Kafka Raft) ржП Kafka ржирж┐ржЬрзЗ ржирж┐ржЬрзЗржЗ metadata manage ржХрж░рзЗред
ржЕрж░рзНржерж╛рзОтАФ ржЖрж░ Zookeeper рж▓рж╛ржЧрзЗ ржирж╛ред

ржХрж┐ржирзНрждрзБ Consumer Rebalance Concept ржЖржЧрзЗрж░ ржорждрзЛржЗ ржЖржЫрзЗред
рж╢рзБржзрзБ Coordinator ржПржЦржи Kafka broker ржирж┐ржЬрзЗрж░ ржнрзЗрждрж░рзЗред

тЬЕ 2. Consumer Rebalancing ржХрзА?

Rebalance ржорж╛ржирзЗ:

ЁЯСЙ тАЬConsumer group-ржПрж░ ржоржзрзНржпрзЗ partition ржЧрзБрж▓рзЛ ржирждрзБржиржнрж╛ржмрзЗ ржмржгрзНржЯржи ржХрж░рж╛тАЭ

ржпржЦржи group-ржП ржкрж░рж┐ржмрж░рзНрждржи ржЖрж╕рзЗ, Kafka ржЖржмрж╛рж░ partition assignment ржХрж░рзЗред

ржХржЦржи ржПржЗ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯ?

ржирждрзБржи ржХрзЛржиржУ consumer join ржХрж░рж▓рзЗ

ржХрзЛржиржУ consumer leave ржХрж░рж▓рзЗ

consumer crash рж╣рж▓рзЗ

consumer slow рж╣рзЯрзЗ heartbeat ржорж┐рж╕ ржХрж░рж▓рзЗ

topic-ржПрж░ partitions ржмрж╛рзЬрж╛рж▓рзЗ

ржПржЗрж╕ржм рж╣рж▓рзЗ Kafka consumer group ржЖржмрж╛рж░ ржнрж╛ржЧ-ржмрж╛ржЯрзЛрзЯрж╛рж░рж╛ ржХрж░рзЗ тЖТ ржПржЯрж╛ржХрзЗржЗ Rebalance ржмрж▓рзЗред

тЬЕ 3. KRaft Mode ржП ржкрж░рж┐ржмрж░рзНрждржи ржХрзА?

Rebalance-ржПрж░ logic ржПржХржЗ, рж╢рзБржзрзБ coordinator ржПржЦржи:

тЬФ Zookeeper тЖТ тЭМ
тЬФ Kafka Broker тЖТ тЬЕ

Kafka broker ржирж┐ржЬрзЗрж░ ржоржзрзНржпрзЗржЗ Raft algorithm ржжрж┐рзЯрзЗ metadata store ржХрж░рзЗ ржПржмржВ group coordination рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рзЗред

тЬЕ 4. Rebalance Example (рж╕рж╣ржЬ ржЙржжрж╛рж╣рж░ржг)

ржзрж░рж┐:

Topic-ржПрж░ 4ржЯрж╛ partition: P0, P1, P2, P3

Consumer group-ржП рж╢рзБрж░рзБрждрзЗ 2 ржЬржи consumer: C1, C2

ЁЯФ╣ Initial Assignment

C1 тЖТ P0, P1

C2 тЖТ P2, P3

ржПржЦржи ржирждрзБржи consumer C3 join ржХрж░рж▓рзЛред

ЁЯФ╣ Kafka Rebalance рж╢рзБрж░рзБ ржХрж░рж▓ тЖТ ржирждрзБржи assignment:

C1 тЖТ P0

C2 тЖТ P1

C3 тЖТ P2, P3

ржПржЗ redistribution-ржЯрж╛ржЗ рж╣рж▓рзЛ consumer rebalanceред

тЬЕ 5. Rebalance ржХрзЗржи рж╣рзЯ?

Kafka ржирж┐ржЪрзЗрж░ ржпрзЗржХрзЛржиржУ ржХрж┐ржЫрзБ detect ржХрж░рж▓рзЗржЗ Rebalance ржХрж░рзЗ тАФ

ржХрж╛рж░ржг	ржмрзНржпрж╛ржЦрзНржпрж╛
ржирждрзБржи consumer join ржХрж░рзЗржЫрзЗ	workload ржнрж╛ржЧ ржХрж░рждрзЗ
consumer leave ржХрж░рзЗржЫрзЗ	ржХрж╛ржЬ ржЕржирзНржпржжрзЗрж░ ржжрж┐рждрзЗ
consumer crash ржмрж╛ slow	Heartbeat timeout
session timeout	consumer stuck
ржирждрзБржи partitions ржпрзЛржЧ ржХрж░рж╛	ржХрж╛ржЬ ржмрж╛рзЬржЫрзЗ
Broker failover	coordinator change
тЬЕ 6. Rebalance-ржПрж░ ржзрж╛ржк (Step-by-step)

Kafka Rebalance 3 ржзрж╛ржкрзЗ рж╣рзЯ:

1я╕ПтГг Join Phase

рж╕ржм consumer coordinator-ржХрзЗ ржмрж▓рзЗтАФ

тАЬржЖржорж┐ group-ржП ржЖржЫрж┐тАЭ

Coordinator ржПржХржЬржи consumer-ржХрзЗ тАЬleaderтАЭ ржмрж╛ржирж╛рзЯред

2я╕ПтГг Sync Phase

Leader ржарж┐ржХ ржХрж░рзЗ ржХрзЛржи partition ржХрзЗ ржкрж╛ржмрзЗред

Coordinator рж╕рзЗржЯрж┐ рж╕ржмрж╛ржЗржХрзЗ ржкрж╛ржарж╛рзЯред

3я╕ПтГг Running Phase

рж╕ржм consumer ржирждрзБржи partition assignment ржирж┐рзЯрзЗ ржЖржмрж╛рж░ message consume рж╢рзБрж░рзБ ржХрж░рзЗред

тЬЕ 7. Rebalance ржЪрж▓рж╛ржХрж╛рж▓рзАржи ржХрж┐ рж╣рзЯ?

Rebalance ржпржЦржи рж╣рзЯ рждржЦржи:

Message ржкрзЬрж╛ тЭМ ржерзЗржорзЗ ржпрж╛рзЯ (pause)

Latency ржмрж╛рзЬрзЗ

System ржХрж┐ржЫрзБржХрзНрж╖ржг slow рж╣рзЯ

рждрж╛ржЗ unnecessary rebalance ржПрзЬрж╛ржирзЛ ржЦрзБржм importantред

тЬЕ 8. Rebalance ржХржорж╛ржирзЛрж░ ржЙржкрж╛рзЯ (Important Best Practices)
тЬФ 1. Cooperative Rebalancing ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
partition.assignment.strategy=org.apache.kafka.clients.consumer.CooperativeStickyAssignor


ржПрждрзЗ stop-the-world rebalance рж╣рзЯ ржирж╛ред

тЬФ 2. Heartbeat ржмрзЬ рж░рж╛ржЦрзБржи
heartbeat.interval.ms=3000
session.timeout.ms=10000


Consumer ржПржХржЯрзБ slow рж╣рж▓рзЗржУ timeout рж╣ржмрзЗ ржирж╛ред

тЬФ 3. Heavy ржХрж╛ржЬ poll() ржорзЗржержбрзЗрж░ ржнрзЗрждрж░рзЗ ржХрж░ржмрзЗржи ржирж╛

Thread pool ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред

тЬФ 4. Consumer shutdown graceful ржХрж░рзБржи
consumer.wakeup();

тЬФ 5. Partition ржмрж╛рж░ржмрж╛рж░ increase ржХрж░рж╛ avoid ржХрж░рзБржи

ржкрзНрж░рждрж┐ржмрж╛рж░ partition ржмрж╛рзЬрж╛рж▓рзЗ full rebalance рж▓рж╛ржЧрзЗред





























ржзрж╛ржкKafka ржЫрж╛ржбрж╝рж╛Kafka ржжрж┐ржпрж╝рзЗржХржиржнрж╛рж░рзНржЯрззрзжрзж ├Ч рзкрзл рж╕рзЗржХрзЗржирзНржб = рзнрзл ржорж┐ржирж┐ржЯрззрзжрзж / рззрзи = рзп ржмрзНржпрж╛ржЪ ├Ч рзо рж╕рзЗржХрзЗржирзНржб = рзнрзи рж╕рзЗржХрзЗржирзНржбржнрзНржпрж╛рж▓рж┐ржбрзЗржЯрззрзжрзж ├Ч рзи ржорж┐ржирж┐ржЯ = рзирзжрзж ржорж┐ржирж┐ржЯрззрзжрзж / рзирзк = рзл ржмрзНржпрж╛ржЪ ├Ч рзирзи рж╕рзЗржХрзЗржирзНржб = рзз.рзо ржорж┐ржирж┐ржЯрж▓рзЛржбрззрзжрзж ├Ч рзпрзж рж╕рзЗржХрзЗржирзНржб = рззрзлрзж ржорж┐ржирж┐ржЯрззрзжрзж / рззрзи = рзп ржмрзНржпрж╛ржЪ ├Ч рззрзл рж╕рзЗржХрзЗржирзНржб = рзи.рзи ржорж┐ржирж┐ржЯржорзЛржЯрзн+ ржШржгрзНржЯрж╛~рзм ржорж┐ржирж┐ржЯ

рзнрзж├Ч ржжрзНрж░рзБржд!
```
